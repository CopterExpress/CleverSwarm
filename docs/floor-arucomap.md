# Навигация по карте напольных маркеров

## Конфигурирование клиента

Файл с конфигурацией клиента по [ссылке](https://www.google.com/ "Еще не разобрался =(").

Аргумент `aruco` в файле `~/catkin_ws/src/clever/clever/launch/clever.launch` должен быть в значении `true`:

```<arg name="aruco" default="true"/>```

Для включения распознавания карт маркеров аргументы `aruco_map` и `aruco_detect` в файле `~/catkin_ws/src/clever/clever/launch/aruco.launch` должны быть в значении `true`:

```
<arg name="aruco_detect" default="true"/>
<arg name="aruco_map" default="true"/>
```

Для включения передачи координат в полетный контроллер по механизму VPE, аргумента `aruco_vpe` должен быть в значении `true`:

```<arg name="aruco_vpe" default="true"/>```

## Настройка файла карты меркеров

Карта маркеров имеет формат `.txt`, и может быть создана в текстовом редакторе по следующему шаблону. Каждая строка имеет формат:

`marker_id   size   x   y   z   x_angle   y_angle   z_angle`

,где `size` - размер стороны квадрата маркера (в метрах), `x y z` - его координаты в пространстве (в метрах), `x_angle` - соответствующий угол вращения вокруг оси (в радианах)

Так же можно вставлять построчные комментарии путём добавления символа `#` в начало строки

Генерацию маркеров для печати можно осуществлять с помощью сайта [генератора аруко-маркеров](http://chev.me/arucogen/). При создании собственной карты рекомендуется избегать "простых" рисунков маркеров, как например, `marker_id = 17`. По умолчанию используются маркеры 4x4. Альтернативный способ создания карты меток представлен по [ссылке](https://clever.coex.tech/ru/arucogenmap.html "Генератор ArUco карт").

Формально для полёта достаточно одного маркера, однако для повышения стабильности полётов рекомендуется равномерно покрывать всю полётную область маркерами. Размер маркеров выбирается так, чтобы из любой точки полётного пространства маркер распознавался по возможности без ошибок.

После создания карты маркеров её необходимо загрузить в папку клиента с помощью меню Сервера `Selected Drones --> Send --> Aruco map`. Название `animation_map.txt` используется по умолчанию. Адрес нахождения карты маркеров на клиенте:

```~/catkin_ws/src/clever/aruco_pose/map/animation_map.txt```

## Проверка карты маркеров

Для того, чтобы проверить правильность выполнения предыдущего пункта, необходимо подключиться к той же Wi-Fi сети, что и клиент, и перейти по ссылке [http://192.168.11.1:8080/snapshot?topic=/aruco_map/image](http://192.168.11.1:8080/snapshot?topic=/aruco_map/image). На экране должна отобразиться заданная карта маркеров. Проверить правильность распознавания карты можно по ссылке [http://192.168.11.1:8080/stream_viewer?topic=/aruco_map/debug](http://192.168.11.1:8080/stream_viewer?topic=/aruco_map/debug)

**Важно!** Распознанное начало координат (обозначается тремя ортогональными RGB стрелками) при распознании карты должно совпадать с реальным физическим началом карты. Не допускается, чтобы начало координат хаотично перемещалось или вращалось при статичной картинке. Если это условие не выполнено, необходимо искать ошибки в расхождении реальной карты и карты, залитой на клиент.

Пример правильно распознанной карты:
![](https://clever.coex.tech/assets/aruco-map-debug.png)
Подробная инструкция по работе с web_video описана [здесь](https://clever.coex.tech/ru/web_video_server.html).

## Полёт 

После выполнения предыдущих пунктов и остальной настройке [клиента](client.md) и [Сервера](server.md) можно проверить удержание позиции Дроном над картой маркеров в режиме `POSITION` и `OFFBOARD`.

Файл конфигурации сервера для полётов по напольной карте маркеров находится [тут](https://www.google.com/ "Еще не готово =(")

Рекомендуется перед выполнением анимации воспользоваться кнопкой `Takeoff` на Сервере для проверки удержания Дроном позиции в пространстве. 
